<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouTube Downloader</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light d-flex align-items-center" style="height: 100vh;">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card shadow-lg">
          <div class="card-body">
            <h3 class="card-title text-center mb-4">üì• YouTube Video Downloader</h3>
            <form id="downloadForm">
              <div class="mb-3">
                <label for="url" class="form-label">YouTube URL</label>
                <input type="text" name="url" id="url" class="form-control" placeholder="Paste YouTube video link here"
                  required>
              </div>
              <div class="mb-3">
                <label for="quality" class="form-label">Select Quality</label>
                <select name="quality" id="quality" class="form-select" required>
                  <option value="bestvideo[height<=2160]+bestaudio/best[height<=2160]">2160p (4K UHD)</option>
                  <option value="bestvideo[height<=1080]+bestaudio/best[height<=1080]">1080p (Full HD)</option>
                  <option value="bestvideo[height<=720]+bestaudio/best[height<=720]">720p (HD)</option>
                  <option value="bestvideo[height<=480]+bestaudio/best[height<=480]">480p (SD)</option>
                  <option value="bestvideo[height<=360]+bestaudio/best[height<=360]">360p (Low)</option>
                  <option value="bestaudio[ext=m4a]">Audio Only (M4A)</option>
                </select>
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-danger">Download</button>
              </div>
            </form>

            <!-- <div id="spinner" class="text-center mt-4 d-none">
              <div class="spinner-border text-danger" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Downloading started...</p>
            </div> -->
            <div id="videoInfo" class="text-center d-none mt-3">
              <img id="videoThumbnail" class="img-fluid rounded mb-2" style="max-height: 200px;" />
              <h5 id="videoTitle" class="fw-semibold"></h5>
            </div>
            <div id="progressContainer" class="mt-4 d-none">
              <label class="form-label">Download Progress</label>
              <div class="progress">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                  style="width: 0%;">0%</div>
              </div>
            </div>

            <p class="mt-3 text-muted small text-center">
              ‚ö†Ô∏è This tool is for personal and educational use only.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("downloadForm");
    const spinner = document.getElementById("spinner");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");

    const socket = new WebSocket("ws://localhost:3000");

    socket.onmessage = (event) => {
      if (event.data.startsWith("done|")) {
        const fileInfo = JSON.parse(event.data.split("|")[1]);

        progressBar.style.width = "100%";
        progressBar.innerText = "Download Complete!";
        progressBar.classList.remove("progress-bar-animated");

        // ‚úÖ Show file name and size
        const infoText = document.createElement("p");
        infoText.className = "mt-2 text-success text-center fw-semibold";
        infoText.innerText = `üìÅ ${fileInfo.fileName} (${fileInfo.fileSize})`;

        // ‚úÖ Create download button
        const downloadBtn = document.createElement("a");
        downloadBtn.href = fileInfo.filePath;
        downloadBtn.className = "btn btn-success mt-2 w-100";
        downloadBtn.innerText = "‚¨áÔ∏è Click to Download File";
        downloadBtn.setAttribute("download", fileInfo.fileName);

        // ‚úÖ Append to progress container
        progressContainer.appendChild(infoText);
        progressContainer.appendChild(downloadBtn);
      } else if (event.data === "error") {
        progressBar.classList.remove("progress-bar-animated");
        progressBar.classList.add("bg-danger");
        progressBar.innerText = "‚ùå Download Failed";
      } else {
        progressContainer.classList.remove("d-none");
        progressBar.style.width = event.data + "%";
        progressBar.innerText = event.data + "%";
      }
    };


    // Clean previous results
    progressContainer.querySelectorAll("a.btn, p.text-success").forEach(el => el.remove());

    form.addEventListener("submit", async (e) => {
      e.preventDefault(); // ‚úÖ Stop page refresh

      // Clear previous download buttons if any
      progressContainer.querySelectorAll("a.btn").forEach(btn => btn.remove());

      // Reset progress bar
      progressBar.style.width = "0%";
      progressBar.innerText = "0%";
      progressBar.classList.add("progress-bar-animated");
      progressContainer.classList.remove("d-none");

      const formData = new FormData(form);
      const url = formData.get("url");

      // üîç Fetch title & thumbnail
      try {
        const infoRes = await fetch("/info", {
          method: "POST",
          body: new URLSearchParams({ url }),
        });
        const info = await infoRes.json();

        if (info.title && info.thumbnail) {
          document.getElementById("videoThumbnail").src = info.thumbnail;
          document.getElementById("videoTitle").innerText = info.title;
          document.getElementById("videoInfo").classList.remove("d-none");
        }
      } catch (err) {
        console.warn("Unable to fetch video info", err);
      }
      try {
        const response = await fetch("/download", {
          method: "POST",
          body: new URLSearchParams(formData),
        });

        if (!response.ok) {
          progressBar.classList.remove("progress-bar-animated");
          progressBar.classList.add("bg-danger");
          progressBar.innerText = "‚ùå Download failed!";
        }

        // No need to handle anything else here;
        // WebSocket will push the result (`done|...`)
      } catch (err) {
        console.error("Fetch error:", err);
        progressBar.classList.remove("progress-bar-animated");
        progressBar.classList.add("bg-danger");
        progressBar.innerText = "‚ùå Error occurred!";
      }
    });

  </script>
</body>

</html>